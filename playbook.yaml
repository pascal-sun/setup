---
- name: Setup
  hosts: localhost

  tasks:

    - name: Gather package facts
      ansible.builtin.package_facts:

    - name: Install packages
      become: true
      ansible.builtin.apt:
        name:
          - curl
        state: present
        update_cache: true

    - name: Install Regolith
      # https://regolith-desktop.com/docs/using-regolith/install/#ubuntu
      become: true
      when: "'regolith-desktop' not in ansible_facts.packages"
      block:
        - name: Register the Regolith public key
          ansible.builtin.get_url:
            url: https://regolith-desktop.org/regolith.key
            dest: /usr/share/keyrings/regolith-archive-keyring.asc
            mode: "0644"

        - name: Add the repository URL
          ansible.builtin.apt_repository:
            filename: regolith
            repo: deb [arch=amd64 signed-by=/usr/share/keyrings/regolith-archive-keyring.asc] https://regolith-desktop.org/release-3_0-ubuntu-jammy-amd64 jammy main

        - name: Install Regolith
          ansible.builtin.apt:
            name:
              - regolith-desktop
              - regolith-session-flashback
              - regolith-look-nord
            state: present
            update_cache: true

    - name: Install fish
      # https://github.com/fish-shell/fish-shell#packages-for-linux
      become: true
      block:
        - name: Add fish repository from PPA
          ansible.builtin.apt_repository:
            repo: ppa:fish-shell/release-3

        - name: Install fish
          ansible.builtin.apt:
            name: fish
            state: present
            update_cache: true

        - name: Default shell
          ansible.builtin.user:
            name: "{{ ansible_user_id }}"
            shell: /usr/bin/fish

    - name: Add ~/.local/bin to PATH
      ansible.builtin.shell: fish_add_path {{ ansible_env.HOME }}/.local/bin
      args:
        executable: /usr/bin/fish
      register: ignore_errors_register
      changed_when: ignore_errors_register.rc == 0
      ignore_errors: true

    - name: Check if Fisher exists
      ansible.builtin.shell: functions -q fisher
      args:
        executable: /usr/bin/fish
      register: fisher
      changed_when: false

    - name: Debug
      ansible.builtin.debug:
        var: fisher
        verbosity: 2

    - name: Install Fisher
      # https://github.com/jorgebucaran/fisher#installation
      when: fisher.rc != 0
      block:
        - name: Download Fisher
          ansible.builtin.get_url:
            url: https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish
            dest: /tmp/fisher.fish
            mode: "0644"

        - name: Install Fisher
          ansible.builtin.shell: source /tmp/fisher.fish && fisher install jorgebucaran/fisher
          args:
            executable: /usr/bin/fish
          changed_when: false


    - name: Install fish's fzf
      # https://github.com/PatrickF1/fzf.fish#installation
      become: true
      ansible.builtin.apt:
        name:
          - fzf # fuzzy finder (https://github.com/junegunn/fzf#using-linux-package-managers)
          - fd-find # simple, fast and user-friendly alternative to "find" (https://github.com/sharkdp/fd#on-ubuntu)
        state: present
        update_cache: true

    - name: Add symlink for fd
      ansible.builtin.file:
        src: /usr/bin/fdfind
        dest: ~/.local/bin/fd
        state: link
